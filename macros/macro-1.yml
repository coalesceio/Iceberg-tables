fileVersion: 1
id: "1"
macroString: |-
  {# ----------------------------------------------------------------------
    Macro: buildcoldict
    Purpose: Builds a dictionary (ns.column_dict) of columns for all sources
  ---------------------------------------------------------------------- #}
  {% macro buildcoldict(ns) %}

      {% if sources is defined %}
          {% for source_idx in range(sources | length) %}
              {% set source = sources[source_idx] %}

              {# Initialize the source entry if missing #}
              {% if source_idx not in ns.column_dict %}
                  {% set _ = ns.column_dict.update({source_idx: {}}) %}
              {% endif %}

              {# Add all columns in this source to the dictionary #}
              {% for column in source.columns %}
                  {% set _ = ns.column_dict[source_idx].update({column.id: column}) %}
              {% endfor %}
          {% endfor %}

      {% endif %}
  {% endmacro %}

  {#--------------------------------------------------------
      The block of code below initializes variables for node types
      that use the advanced deployment strategy
  ----------------------------------------------------------#}
  {% if desiredState %}
      {% set columns = desiredState.columns %}
      {% set storageLocations = desiredState.storageLocations %}
      {% set config = desiredState.config %}
      {% set sources = desiredState.sources %}
      {% set node = desiredState.node %}
      {% set parameters = desiredState.parameters %}

      {% set ns = namespace(column_dict = {}) %}
      {# Populate column dictionary #}
      {{ buildcoldict(ns) }}

  {% endif %}

  {#-----------------------------------------------------------------
   	Macro: icebergcoldatatype
    	Purpose: Converts Snowflake column data types into their equivalent Iceberg-compatible types.
             - VARCHAR → STRING
             - TIMESTAMP → TIMESTAMP
             - TIME → TIME
             - Otherwise, passes through the original type.
  -------------------------------------------------------------------#}
  {% macro icebergcoldatatype( coldatatype ) %}

  	{% set nsVariables = namespace(ibcoldatatype = "") %}

  	{% if 'VARCHAR' in coldatatype %}
  		{% set nsVariables.ibcoldatatype = 'STRING' %}
  	{% elif 'TIMESTAMP' in coldatatype %}
  		{% set nsVariables.ibcoldatatype = 'TIMESTAMP' %}
  	{% elif 'TIME' in coldatatype %}
  		{% set nsVariables.ibcoldatatype = 'TIME' %}
  	{% else %}
  		{% set nsVariables.ibcoldatatype = coldatatype %}
  	{% endif %}
  	
  	{{ nsVariables.ibcoldatatype }}

  {% endmacro %}

  {# ----------------------------------------------------------------------
    Macro: dimensionHistoryPk
    Builds a composite key for dimension history:
     - Joins partition columns from partition_by('DIM')
     - Adds order_by_col() for uniqueness
     - Uses epoch millis or MD5(order_by_col) depending on record versioning
  ----------------------------------------------------------------------  #}
  {% macro dimensionHistoryPk() %}

      {%- set nsVariables = namespace(dimensionHistoryColumns = "") -%}
      {%- set partitionBy = partition_by('DIM').split("~") -%}
      {%- set orderBy = order_by_col() -%}

      {%- for col in partitionBy -%}
          {%- if loop.first -%}
              {%- set nsVariables.dimensionHistoryColumns = col -%}
          {%- else -%}
              {%- set nsVariables.dimensionHistoryColumns = nsVariables.dimensionHistoryColumns + ' || ' + '\'-\'' + ' ||' + col -%}
          {%- endif -%}
      {%- endfor -%}

      {% if config.recordVersioning not in ('Integer Column') %}
          {%- set nsVariables.dimensionHistoryColumns = nsVariables.dimensionHistoryColumns + ' || ' + '\'-\'' + ' || date_part(epoch_milliseconds, ' + orderBy + ')' -%}
      {% else %}
          {%- set nsVariables.dimensionHistoryColumns =  nsVariables.dimensionHistoryColumns ~ " || '-' || " ~ orderBy -%}
          {%- set nsVariables.dimensionHistoryColumns = "MD5(" ~ nsVariables.dimensionHistoryColumns ~")" -%}
      {% endif %}

      {{- nsVariables.dimensionHistoryColumns -}}

  {% endmacro %}

  {# ---------------------------------------------------------------------- 
    Macro: partition_by
    Purpose: Builds a partition key string for a node.
              - Uses '~' delimiter for DIM nodes, ',' otherwise.
              - Concatenates partitionBy config columns with proper transforms.
    Output: Returns the partition expression as a string.
  ----------------------------------------------------------------------  #}
  {% macro partition_by(nodetype) %}

      {# Create namespaces #}
      {% set nsVars = namespace(partition = "", delim = "") %}

      {# Choose delimiter based on node type #}
      {% if nodetype == 'DIM' %}
          {% set nsVars.delim = '~' %}
      {% else %}
          {% set nsVars.delim = ',' %}
      {% endif %}

      {# Build partition expression #}
      {% if config is defined and config.partitionBy is defined %}
          {% for item in config.partitionBy.get('items', []) %}
          
          {% set part_col = ns.column_dict[0][item.partColName.id] %}
          
          {%- if loop.first -%}
                  {%- set nsVars.partition = get_source_transform(part_col) -%}
              {%- else -%}
                  {%- set nsVars.partition = nsVars.partition + nsVars.delim + get_source_transform(part_col) -%}
              {%- endif -%}
          {% endfor %}
      {% endif %}

    {{ nsVars.partition }}

  {% endmacro %}

  {# ----------------------------------------------------------------------
    Macro: order_by_col
    Purpose: Returns the column expression used for ordering in record versioning.
     - If "Datetime Column": uses the configured datetime column.
     - If "Integer Column": uses the configured sequence column.
     - Otherwise: combines separate date and time columns into a timestamp.
    Output: Order-by column expression as a string.
    ----------------------------------------------------------------------#}
  {% macro order_by_col(return) %}

      {% set nsVariables = namespace(orderBy = "") -%}
    
      {% if config.recordVersioning in ('Datetime Column') -%}
          
          {% set datetimeColSort = config.orderBy.get('items', []) -%}		
          {% set dateTimeCol = ns.column_dict[0][datetimeColSort[0].colName.id] -%}        
          {% set nsVariables.orderBy = get_source_transform(dateTimeCol) -%}

  	{% elif config.recordVersioning in ('Integer Column')%}
          
          {% set datetimeNumericColSort = config.orderseq.get('items',[]) -%}
  	    {% set dateTimeCol = ns.column_dict[0][datetimeNumericColSort[0].colNameseq.id] -%}        
          {% set nsVariables.orderBy = get_source_transform(dateTimeCol) -%}
            
      {% else -%}

          {% set dateTimeColSort = config.orderByDateTime.get('items',[]) -%}
          {% set dateCol = ns.column_dict[0][dateTimeColSort[0].colNameDate.id] -%}
          {% set timeCol = ns.column_dict[0][dateTimeColSort[0].colNameTimestamp.id] -%}
          {% set nsVariables.orderBy = 'to_timestamp(' + get_source_transform(dateCol) +  '|| ' + '\'T\'' + ' ||' + get_source_transform(timeCol) +  ')' -%}
          
      {% endif -%}

      {{ nsVariables.orderBy }}

  {% endmacro %}

  {# ----------------------------------------------------------------------
    Macro: order_by_col_int
    Purpose:
      - Reads the configured "recordorderBy" column from the node settings.
      - Finds the matching column metadata by column ID.
   Output: Transformed column expression to be used in ORDER BY.
  ------------------------------------------------------------------------#}
  {% macro order_by_col_int(return) %}

      {% set nsVariables = namespace(orderBy = "") -%}

        {% set datetimeNumericColSort = config.recordorderBy.get('items',[]) %}
  	  {% set dateTimeCol = ns.column_dict[0][datetimeNumericColSort[0].ocolName.id] -%}    
        {% set nsVariables.orderBy = get_source_transform(dateTimeCol) -%} 
            
      {{ nsVariables.orderBy }}

  {% endmacro %}
name: macro
type: Macro
